name: Docset Sync

on:
  push:
    branches: [main]
  schedule:
  - cron: '0 0 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  sync-dash:
    name: Sync Dash Docsets
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Clone Dash Repositories
      run: |
        git clone https://github.com/Kapeli/feeds.git build/feeds
        git clone https://github.com/Kapeli/Dash-X-Platform-Resources.git build/resources

    - name: Execute
      run: |
        sudo apt-get -y -qq --no-install-recommends install python3-png
        ./process_dash_feeds.py \
          --manifest=docsets.json \
          --blacklist=blacklist.json \
          --resource-dir=build/resources \
          build/feeds \
          public/docsets.json

    - name: Deploy to Netlify
      uses: nwtgck/actions-netlify@v2
      with:
        publish-dir: public
        production-branch: main
        netlify-config-path: netlify.toml
        alias: ${{ github.head_ref }}
        deploy-message: "Deployed with GitHub Actions"
        enable-pull-request-comment: false
        enable-commit-comment: false
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      timeout-minutes: 1
